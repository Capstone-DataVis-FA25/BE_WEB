generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Chart {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String         @unique
  description  String?
  type         String
  config       Json
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  datasetId    String?        @db.Uuid
  userId       String         @db.Uuid
  dataset      Dataset?       @relation(fields: [datasetId], references: [id])
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  chartNotes   ChartNote[]
  chartHistory ChartHistory[]
}

model ChartNote {
  id          String    @id(map: "chart_notes_pkey") @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  content     String
  createdAt   DateTime  @default(now())
  chartId     String    @db.Uuid
  authorId    String    @db.Uuid
  isCompleted Boolean   @default(false)
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade, map: "chart_notes_authorId_fkey")
  chart       Chart     @relation(fields: [chartId], references: [id], onDelete: Cascade, map: "chart_notes_chartId_fkey")

  @@index([authorId], map: "chart_notes_authorId_idx")
  @@index([chartId], map: "chart_notes_chartId_idx")
}

model DataHeader {
  id               String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String
  type             String
  index            Int
  dateFormat       String? @default("YYYY-MM-DD")
  encryptedData    String
  iv               String
  authTag          String
  encryptedDataKey String
  datasetId        String  @db.Uuid
  dataset          Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
}

model Dataset {
  id                 String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String       @unique
  description        String?
  rowCount           Int
  columnCount        Int
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  userId             String       @db.Uuid
  decimalSeparator   String?      @default(".")
  thousandsSeparator String?      @default(",")
  charts             Chart[]
  headers            DataHeader[]
  user               User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  chartHistory       ChartHistory[]
}

model User {
  id                        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                     String           @unique
  password                  String?
  firstName                 String?
  lastName                  String?
  role                      UserRole         @default(USER)
  isActive                  Boolean          @default(true)
  isVerified                Boolean          @default(false)
  subscriptionPlanId        String?          @db.Uuid
  subscriptionPlan          SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  createdAt                 DateTime         @default(now())
  updatedAt                 DateTime         @updatedAt
  currentHashedRefreshToken String?
  currentVerifyToken        String?
  charts                    Chart[]
  chartNotes                ChartNote[]
  datasets                  Dataset[]
  chartHistory              ChartHistory[]
  paymentTransactions       PaymentTransaction[]
}

enum UserRole {
  USER
  ADMIN
}

model ActivityLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  actorId    String?  @db.Uuid
  actorType  String?                // e.g. "USER", "SYSTEM", "ADMIN"
  action     String                 // e.g. "CREATE_DATASET", "LOGIN", ...
  resource   String?                // e.g. "Dataset:uuid" or resource type/id
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([actorId])
}

model SubscriptionPlan {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String     @unique
  description String?
  price       Float
  currency    String     @default("USD")
  interval    String     @default("month") // month, year, etc.
  features    String[]   // List of features included in this plan
  limits      Json?      // Usage limits (e.g., max datasets, max charts, etc.)
  isActive    Boolean    @default(true)
  sortOrder   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  stripePriceId String?   // For integration with Stripe (optional)
  users       User[]
  paymentTransactions PaymentTransaction[]
}

model ChartHistory {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chartId     String   @db.Uuid
  datasetId   String   @db.Uuid
  name        String
  description String?
  type        String
  config      Json     // Lưu config cũ trước khi update
  createdAt   DateTime @default(now())
  updatedBy   String   @db.Uuid
  changeNote  String?  // Ghi chú về thay đổi (optional)
  chart       Chart    @relation(fields: [chartId], references: [id], onDelete: Cascade)
  dataset     Dataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [updatedBy], references: [id])

  @@index([chartId], map: "chart_history_chartId_idx")
  @@index([createdAt], map: "chart_history_createdAt_idx")
}

model PaymentTransaction {
  id                      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                  String?  @db.Uuid
  subscriptionPlanId      String?  @db.Uuid
  amount                  Float
  currency                String   @default("USD")
  status                  PaymentStatus @default(PENDING)
  provider                String?  // e.g. "stripe"
  providerTransactionId   String?  @unique
  metadata                Json?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  user                    User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionPlan        SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}